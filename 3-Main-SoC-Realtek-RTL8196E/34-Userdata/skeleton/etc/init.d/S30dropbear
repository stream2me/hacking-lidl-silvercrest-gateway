#!/bin/sh
#
# S30dropbear - Dropbear SSH server startup script (user-editable)
#
# This script starts or stops the Dropbear SSH server.
# You can customize the DROPBEAR_OPTS variable below.
#
# Common Dropbear options:
#   -p [port]   : Listen on specified port (default: 22)
#   -w          : Disallow root logins
#   -s          : Disable password logins (only pubkey allowed)
#   -g          : Allow root logins without password (pubkey only)
#   -F          : Run in foreground (useful for debugging)
#   -K [seconds]: Disconnect if no traffic is transmitted during K seconds
#
# For all options: https://manned.org/dropbear.8
#
# J. Nilo - May 2025
#
DROPBEAR_OPTS="-p 22 -K 300"
KEYDIR="/etc/dropbear"
PIDFILE="/var/run/dropbear.pid"

# Generate server keys only once at the first login
generate_keys() {
    echo "üîê Checking Dropbear host keys..."

    mkdir -p "$KEYDIR"
    chmod 700 "$KEYDIR"
    [ -f "$KEYDIR/dropbear_rsa_host_key" ] || {
        echo "üîë Generating RSA host key..."
        dropbearkey -t rsa -f "$KEYDIR/dropbear_rsa_host_key"
    }

    [ -f "$KEYDIR/dropbear_ecdsa_host_key" ] || {
        echo "üîë Generating ECDSA host key..."
        dropbearkey -t ecdsa -f "$KEYDIR/dropbear_ecdsa_host_key"
    }

    [ -f "$KEYDIR/dropbear_ed25519_host_key" ] || {
        echo "üîë Generating ED25519 host key..."
        dropbearkey -t ed25519 -f "$KEYDIR/dropbear_ed25519_host_key"
    }
}
case "$1" in
start)
    generate_keys
    echo "üöÄ Starting Dropbear with options: $DROPBEAR_OPTS"
    dropbear $DROPBEAR_OPTS
    ;;
stop)
    echo "üõë Stopping Dropbear..."
    if [ -f "$PIDFILE" ]; then
        kill "$(cat "$PIDFILE")" && rm -f "$PIDFILE"
    else
        killall dropbear 2>/dev/null
    fi
    ;;
restart)
    stop
    sleep 1
    start
    ;;
*)
    echo "‚ÑπÔ∏è  Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac
