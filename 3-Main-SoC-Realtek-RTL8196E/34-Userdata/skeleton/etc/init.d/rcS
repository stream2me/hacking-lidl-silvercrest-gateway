#!/bin/sh
#
# rcS - Main startup script called by init at system boot (runlevel S).
#
# This script executes all system initialization scripts located in /etc/init.d/
# in alphanumeric order (Sxx*), as long as they are executable.
#
# It then checks whether the directory /userdata/etc/init.d exists.
# If so, it also executes all user-provided scripts named Sxx* in that
# directory, in order, as long as they are executable.
#
# This allows users to extend the system initialization process
# without modifying the read-only root filesystem (e.g. SquashFS).
#
# J. Nilo, May 2025
#

# Logging function - outputs to both console and syslog
log_echo() {
    echo "$1"
    [ "$INIT_VERBOSE" != "0" ] && logger -t "rcS" "$1"
}

[ "$INIT_VERBOSE" = "0" ] && exec >/dev/null

log_echo ""
log_echo "▶   Launching core system init scripts..."
for i in /etc/init.d/S??*; do
    if [ -x "$i" ]; then
        log_echo "Starting $i"
        "$i" start 2>&1 | while read line; do
            echo "$line"
            [ "$INIT_VERBOSE" != "0" ] && logger -t "rcS" "$line"
        done
    fi
done
log_echo "✅ System init completed"
