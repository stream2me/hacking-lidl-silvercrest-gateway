#!/bin/sh
#
# S20time - Set timezone and synchronize time at boot using BusyBox ntpd
#
# This script is for embedded systems where /etc/TZ and /etc/ntp.conf
# are symlinks into a writable overlay (e.g. from /userdata).
#
# Behavior:
#   - If ENABLE_NTPD_DAEMON="N" (default), ntpd is run once with -q
#   - If ENABLE_NTPD_DAEMON="O", ntpd runs continuously as a daemon
#   - Internet connectivity is checked before attempting NTP sync
#
# Configuration files:
#   - /etc/TZ         ‚Üí contains the timezone string (exported to TZ)
#       Example for Europe/Paris:
#       echo "CET-1CEST,M3.5.0/2,M10.5.0/3" > /etc/TZ
#   - /etc/ntp.conf   ‚Üí list of NTP servers, one per line
#       Example:
#           server 0.pool.ntp.org
#           server 1.pool.ntp.org
#
# J. Nilo - May 2025
#
### Configuration ###
ENABLE_NTPD_DAEMON="N"      # "Y" = run ntpd continuously, "N" = run once with -q
CONNECTIVITY_TEST="8.8.8.8" # IP to ping for connectivity check
PING_COUNT="1"              # Number of ping attempts
PING_TIMEOUT="2"            # Timeout in seconds
######################

NTPCONF="/etc/ntp.conf"
TZFILE="/etc/TZ"

# Function to check for internet connectivity
check_connectivity() {
    if ping -c "$PING_COUNT" -W "$PING_TIMEOUT" "$CONNECTIVITY_TEST" >/dev/null 2>&1; then
        return 0 # Success - we have connectivity
    else
        return 1 # Failure - no connectivity
    fi
}

case "$1" in
start)
    # Set timezone if available (always do this regardless of connectivity)
    if [ -f "$TZFILE" ]; then
        TZ=$(cat "$TZFILE")
        echo "üïì Setting timezone to $TZ"
        export TZ="$TZ"
    fi

    # Check for NTP config
    if [ ! -f "$NTPCONF" ]; then
        echo "‚ö†Ô∏è No $NTPCONF found, skipping NTP sync."
        exit 0
    fi

    # Check for internet connectivity before attempting NTP
    if ! check_connectivity; then
        echo "üì∂ No internet connectivity detected, skipping NTP sync."
        exit 0
    fi

    # Run ntpd only if we have internet connectivity
    if [ "$ENABLE_NTPD_DAEMON" = "Y" ]; then
        echo "üöÄ Starting ntpd in daemon mode"
        ntpd &
    else
        echo "üîÅ Running ntpd -q (one-shot time sync)"
        ntpd -q
    fi
    ;;
stop)
    if [ "$ENABLE_NTPD_DAEMON" = "Y" ]; then
        echo "üõë Stopping ntpd"
        killall ntpd 2>/dev/null
    else
        echo "‚ÑπÔ∏è ntpd -q was used; nothing to stop"
    fi
    ;;
restart)
    "$0" stop
    sleep 1
    "$0" start
    ;;
*)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac
