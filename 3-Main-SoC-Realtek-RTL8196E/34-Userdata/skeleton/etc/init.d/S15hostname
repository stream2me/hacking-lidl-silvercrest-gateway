#!/bin/sh
#
# S15hostname â€” Set system hostname and update /etc/hosts
# -----------------------------------------------------------------------------
# This script:
#   1. Reads the hostname from /etc/hostname and sets it via the BusyBox `hostname` applet.
#   2. Reads the current IP from /var/run/current_eth0_ip (written by DHCP client or static config).
#   3. Updates /etc/hosts with localhost, and the current IP mapped to the hostname.
#   4. If the IP is fallback (192.168.1.254), notes this in the logs but continues.
#
# Dependencies:
#   - /etc/hostname must exist and contain a valid hostname.
#   - /var/run/current_eth0_ip must contain the IP address (normal or fallback).
#
# J. Nilo - Nov 2025
#
[ "$INIT_VERBOSE" = "0" ] && exec >/dev/null

# Set system hostname
HOSTNAME=$(cat /etc/hostname)
hostname -F /etc/hostname

# Read IP assigned to eth0
CURRENT_IP=$(cat /var/run/current_eth0_ip 2>/dev/null || echo "")

# Check if IP is valid
if [ -z "$CURRENT_IP" ]; then
    echo "âš ï¸  Warning: eth0 has no IP address configured"
    # Use the default IP as fallback if none is set
    CURRENT_IP="192.168.1.254"
elif [ "$CURRENT_IP" = "192.168.1.254" ]; then
    echo "â„¹ï¸  Note: Using fallback IP address 192.168.1.254"
else
    echo "ðŸ·ï¸  Hostname set to $HOSTNAME at $CURRENT_IP"
fi

# Write /var/hosts (symlinked from /etc/hosts to avoid jffs2 writes)
cat >/var/hosts <<EOF
127.0.0.1         localhost
$CURRENT_IP       $HOSTNAME
EOF

# Write /var/resolv.conf (symlinked from /etc/resolv.conf to avoid jffs2 writes)
cat >/var/resolv.conf <<EOF
nameserver 8.8.8.8
nameserver 1.1.1.1
EOF

# Clean-up
if [ -f /var/run/current_eth0_ip ]; then
    rm /var/run/current_eth0_ip
fi

exit 0
