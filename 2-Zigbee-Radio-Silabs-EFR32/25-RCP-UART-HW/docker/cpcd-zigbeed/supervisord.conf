[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

# socat-cpc: Bridge TCP from gateway to PTY for cpcd
# Gateway:8888 -> /tmp/ttyCpcRcp
[program:socat-cpc]
command=/usr/bin/socat -d -d pty,raw,echo=0,link=/tmp/ttyCpcRcp tcp:%(ENV_RCP_HOST)s:%(ENV_RCP_PORT)s,retry=10,interval=5
autostart=true
autorestart=true
startsecs=2
startretries=999
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=100

# cpcd: CPC daemon connecting to RCP via PTY
# Reads /tmp/ttyCpcRcp, exposes CPC sockets in /dev/shm/cpcd/
[program:cpcd]
command=/usr/local/bin/cpcd -c /etc/cpcd/cpcd.conf
autostart=true
autorestart=true
startsecs=5
startretries=10
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=200

# socat-pty-zigbeed: Create PTY pair for zigbeed
# /tmp/ttyZigbeed (for zigbeed) <-> /tmp/ttyZigbeedHost (for TCP bridge)
[program:socat-pty-zigbeed]
command=/usr/bin/socat -d -d pty,raw,echo=0,link=/tmp/ttyZigbeed pty,raw,echo=0,link=/tmp/ttyZigbeedHost
autostart=true
autorestart=true
startsecs=2
startretries=999
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=250

# zigbeed: Zigbee stack daemon (EmberZNet 8.x)
# Connects to cpcd via CPC sockets, uses PTY /tmp/ttyZigbeed
[program:zigbeed]
command=/bin/sh -c 'while [ ! -e /tmp/ttyZigbeed ]; do sleep 1; done; exec /usr/local/bin/zigbeed -r "spinel+cpc://%(ENV_CPCD_INSTANCE)s?iid=1&iid-list=0" -p /tmp/ttyZigbeed -d %(ENV_ZIGBEED_DEBUG)s'
directory=/var/lib/zigbeed
autostart=true
autorestart=true
startsecs=10
startretries=10
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=300

# socat-zigbeed: Bridge zigbeed PTY to TCP for external access (Z2M)
# /tmp/ttyZigbeedHost -> TCP:9999
[program:socat-zigbeed]
command=/bin/sh -c 'while [ ! -e /tmp/ttyZigbeedHost ]; do sleep 1; done; exec socat -d tcp-listen:%(ENV_ZIGBEED_PORT)s,reuseaddr,fork file:/tmp/ttyZigbeedHost,raw,echo=0,nonblock'
autostart=true
autorestart=true
startsecs=5
startretries=999
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=400

[eventlistener:process_exit]
command=/bin/sh -c 'echo "READY"; while read line; do echo "RESULT 2"; echo "OK"; done'
events=PROCESS_STATE_FATAL
