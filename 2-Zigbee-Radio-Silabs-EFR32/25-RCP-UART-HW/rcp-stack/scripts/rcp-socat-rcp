#!/usr/bin/env bash
set -euo pipefail

# RCP_ENDPOINT format validated by rcp-check-endpoint before this script runs

pty="${CPC_RCP_PTY:-/tmp/ttyCpcRcp}"
endpoint="${RCP_ENDPOINT:?RCP_ENDPOINT is not set}"

# Normalize to socat TCP: format
endpoint="${endpoint#[Tt][Cc][Pp]://}"
endpoint="${endpoint#[Tt][Cc][Pp]:}"
endpoint="${endpoint#//}"
endpoint="TCP:${endpoint},forever,interval=1"

exec /usr/bin/socat pty,link="$pty",raw,echo=0,mode=660,waitslave "$endpoint"
