#!/usr/bin/env bash
set -euo pipefail

path="${1:-}"
timeout="${READY_TIMEOUT:-20}"
interval="${READY_POLL_INTERVAL:-0.2}"

if [ -z "$path" ]; then
  echo "usage: rcp-wait-pty PATH" >&2
  exit 2
fi

SECONDS=0
while (( SECONDS < timeout )); do
  if [ -e "$path" ]; then
    if exec 3<>"$path" 2>/dev/null; then
      exec 3>&-
      exit 0
    fi
  fi
  sleep "$interval"
done

echo "Timed out waiting for PTY: $path" >&2
exit 1
